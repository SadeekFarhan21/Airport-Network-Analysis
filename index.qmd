---
title: "Airport Network Analysis"
author: "Farhan"
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    code-fold: true
    code-tools: true
    embed-resources: false
editor: visual
---

```{=html}
<style>
@import url('https://fonts.googleapis.com/css2?family=Funnel+Sans:ital,wght@0,300..800;1,300..800&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&family=Fragment+Mono:ital@0;1&display=swap');
p {
  font-family: 'Funnel Sans';
}
pre, code {
  font-family: 'Fragment Mono';
  font-size: 14px;
}
</style>
```

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(igraph)
library(ggraph)
library(googlesheets4)
library(network)
library(sna)
```

## Ego Network

```{r}
# Reading the dataset
ego_net_link = "https://notes.farhansadeek.com/dartmouth/math7/homework/Ego_Network.csv"
ego <- read.csv(ego_net_link)
ego_network <- graph_from_data_frame(ego, directed = FALSE)
plot(ego_network, vertex.size=5, vertex.label=NA)
```

## Flight Network
First of all, we need to read the dataset. Since we are reading a large amount of data, it's scattered across multiple CSV files so we have to read and combine all of them. Now, we will first look at the files in the directory to make exist there
```{r, results='hide'}
## Listing all the files in the 'dataset' directory
files <- list.files(path = "dataset", pattern = "flightlist_.*\\.csv$", full.names = TRUE) 
files
```
Perfect, all the files exist in that dataframe. Now we will read all of them in order and combine that into a massive dataset.
```{r, results='hide'}
df <- files |> map_df(~read_csv(.))
```
Since we just read a massive amount of data, let's check how much memory it is using in the RAM.

```{r}
format(object.size(df), units = "Gb")
```
Since we are using about 5 GB of memory, we will take a small (1%) random sample of the data to work with just for efficiency purposes.
```{r}
sampled_df <- df |> slice_sample(prop = 0.0001)
```

Now, there are a lot of columns in the dataset that we don't need at all. So we will select only the ones that we need for our analysis. We need to have `origin`, `destination`, `latitude_1`, `longitude_1`, `latitude_2`, and `longitude_2` for our analysis. Here `longitude_1`, `latitude_1` maps to `origin` and `longitude_2`, `latitude_2` maps to `destination`. We will also drop any rows that have NA values in these columns, after that.

```{r}
sampled_df <- sampled_df |> select(origin, destination, latitude_1, longitude_1, latitude_2, longitude_2) |> drop_na()
```

```{r, echo=FALSE}
format(object.size(sampled_df), units = "Mb")
# View(sampled_df)
```

Great, now that we have the data we need we can finally start working on it. However, we can't work with this immediately we need to convert this into a list of vertex, and edge list. We will create the list of edges first, which is just the count from the origin to the destination, and this would be a directed graph.

```{r}
edges <- sampled_df |> group_by(origin, destination) |> summarise(weight = n())
# View(edges)
```
Now, we will create the list of vertices, which is just the airports in the dataset. For this since we have destinations and origins we will first get all the origin nodes, and their information, and then the destinations and their information. When we combine them then we get the full list of nodes.
```{r}

origins <- sampled_df |>
  select(name = origin, lat = latitude_1, long = longitude_1)

destinations <- sampled_df |>
  select(name = destination, lat = latitude_2, long = longitude_2)

nodes <- bind_rows(origins, destinations) |>
  distinct(name, .keep_all = TRUE) |>
  na.omit()
# View(nodes) Test if it works
```

So, now we have the nodes and the edges to work with. First we make this into a graph if we want to be able to do anything with it. We will also remove all the self-loops.

```{r}
flight_network <- graph_from_data_frame(d = edges, vertices = nodes, directed = TRUE)
flight_network <- simplify(flight_network, remove.multiple = TRUE, remove.loops = TRUE)
flight_network
```
So now, we have all the edges that we need to work with. 
## Vertex and Edge Characteristics
```{r}
hist(degree(flight_network), 
     col = "blue", 
     xlim = c(0, 150), 
     breaks = 150,
     xlab = "Vertex Degree", 
     ylab = "Frequency", 
     main = "Degree Distribution")
```

```{r}
dd.flights <- degree_distribution(flight_network)
max_d <- max(degree(flight_network))
d <- 0:max_d
ind <- (dd.flights != 0)
plot(d[ind], dd.flights[ind], 
     log = "xy", 
     col = "blue",
     xlab = "Log-Degree", 
     ylab = "Log-Intensity",
     main = "Log-Log Degree Distribution")
```


```{r}
a.nn.deg.flight <- graph.knn(flight_network, V(flight_network), weights = E(flight_network)$weight)$knn 
plot(degree(flight_network), a.nn.deg.flight, 
     log = "xy", 
     col = "blue",
     xlab = "Log Vertex Degree", 
     ylab = "Log Average Neighbor Degree",
     main = "Log-Log Degree vs Average Neighbor Degree")
```

```{r}
# 1. Identify the top 200 airports by degree
top_nodes <- order(degree(flight_network), decreasing=TRUE)[1:200]

# 2. Create a subnetwork of just these hubs [cite: 178-180]
hubs_subgraph <- induced_subgraph(flight_network, top_nodes)

# 3. Convert ONLY the subnetwork to sna format [cite: 1154]
A_sub <- as.matrix(get.adjacency(hubs_subgraph))
net_sub <- network::as.network.matrix(A_sub)

# 4. Plot (This should take seconds instead of minutes) [cite: 1126-1133]
library(sna)
sna::gplot.target(net_sub, 
                  sna::degree(net_sub), 
                  main="Top 200 Flight Hubs",
                  circ.lab = FALSE, 
                  circ.col="skyblue", 
                  usearrows = FALSE, 
                  edge.col="darkgray")
```

```{r}

```